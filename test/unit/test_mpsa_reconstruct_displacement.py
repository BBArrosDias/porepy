import numpy as np
import scipy.sparse as sps
import unittest

import porepy as pp


class MpsaReconstructDisplacement(unittest.TestCase):
    def test_cart_2d(self):
        nx = 1
        ny = 1
        g = pp.CartGrid([nx, ny], physdims=[2, 2])
        g.compute_geometry()
        g = make_true_2d(g)
        sc_top = pp.fvutils.SubcellTopology(g)

        D_g, CC = pp.numerics.fv.mpsa.reconstruct_displacement(g, sc_top, eta=0)

        D_g_known = np.array(
            [
                [-1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
                [0., -1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
                [0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
                [0., 0., 0., 0., 0., -1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
                [0., 0., 0., 0., 0., 0., 0., 0., -1., 0., 0., 0., 0., 0., 0., 0.],
                [0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0.],
                [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 0.],
                [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 0.],
                [0., 0., -1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
                [0., 0., 0., -1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
                [0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
                [0., 0., 0., 0., 0., 0., 0., -1., 0., 0., 0., 0., 0., 0., 0., 0.],
                [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., -1., 0., 0., 0., 0., 0.],
                [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0.],
                [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0.],
                [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 1.],
            ]
        )

        CC_known = np.array(
            [
                [1., 0.],
                [1., 0.],
                [1., 0.],
                [1., 0.],
                [1., 0.],
                [1., 0.],
                [1., 0.],
                [1., 0.],
                [0., 1.],
                [0., 1.],
                [0., 1.],
                [0., 1.],
                [0., 1.],
                [0., 1.],
                [0., 1.],
                [0., 1.],
            ]
        )

        self.assertTrue(np.all(np.abs(D_g - D_g_known) < 1e-12))
        self.assertTrue(np.all(np.abs(CC - CC_known) < 1e-12))

    def test_simplex_2d(self):
        nx = 1
        ny = 1
        g = pp.StructuredTriangleGrid([nx, ny], physdims=[1, 1])
        g.compute_geometry()
        g = make_true_2d(g)
        sc_top = pp.fvutils.SubcellTopology(g)

        D_g, CC = pp.numerics.fv.mpsa.reconstruct_displacement(g, sc_top, eta=0)

        indices = np.array(
            [
                1,
                0,
                1,
                0,
                5,
                4,
                5,
                4,
                9,
                8,
                9,
                8,
                13,
                12,
                13,
                12,
                17,
                16,
                17,
                16,
                21,
                20,
                21,
                20,
                3,
                2,
                3,
                2,
                7,
                6,
                7,
                6,
                11,
                10,
                11,
                10,
                15,
                14,
                15,
                14,
                19,
                18,
                19,
                18,
                23,
                22,
                23,
                22,
            ]
        )
        indptr = np.array(
            [
                0,
                2,
                4,
                6,
                8,
                10,
                12,
                14,
                16,
                18,
                20,
                22,
                24,
                26,
                28,
                30,
                32,
                34,
                36,
                38,
                40,
                42,
                44,
                46,
                48,
            ]
        )
        data = np.array(
            [
                -1 / 3,
                -1 / 6,
                1 / 6,
                -1 / 6,
                -1 / 3,
                -1 / 6,
                1 / 6,
                1 / 3,
                1 / 6,
                -1 / 6,
                1 / 6,
                1 / 3,
                -1 / 6,
                -1 / 3,
                -1 / 6,
                1 / 6,
                -1 / 6,
                -1 / 3,
                1 / 3,
                1 / 6,
                -1 / 6,
                1 / 6,
                1 / 3,
                1 / 6,
                -1 / 3,
                -1 / 6,
                1 / 6,
                -1 / 6,
                -1 / 3,
                -1 / 6,
                1 / 6,
                1 / 3,
                1 / 6,
                -1 / 6,
                1 / 6,
                1 / 3,
                -1 / 6,
                -1 / 3,
                -1 / 6,
                1 / 6,
                -1 / 6,
                -1 / 3,
                1 / 3,
                1 / 6,
                -1 / 6,
                1 / 6,
                1 / 3,
                1 / 6,
            ]
        )

        D_g_known = sps.csr_matrix((data, indices, indptr))

        CC_known = np.array(
            [
                [1., 0., 0., 0.],
                [1., 0., 0., 0.],
                [1., 0., 0., 0.],
                [1., 0., 0., 0.],
                [1., 0., 0., 0.],
                [1., 0., 0., 0.],
                [0., 0., 1., 0.],
                [0., 0., 1., 0.],
                [0., 0., 1., 0.],
                [0., 0., 1., 0.],
                [0., 0., 1., 0.],
                [0., 0., 1., 0.],
                [0., 1., 0., 0.],
                [0., 1., 0., 0.],
                [0., 1., 0., 0.],
                [0., 1., 0., 0.],
                [0., 1., 0., 0.],
                [0., 1., 0., 0.],
                [0., 0., 0., 1.],
                [0., 0., 0., 1.],
                [0., 0., 0., 1.],
                [0., 0., 0., 1.],
                [0., 0., 0., 1.],
                [0., 0., 0., 1.],
            ]
        )
        self.assertTrue(np.all(np.abs(D_g - D_g_known).A < 1e-12))
        self.assertTrue(np.all(np.abs(CC - CC_known) < 1e-12))

    def test_cart_3d(self):
        g = pp.CartGrid([1, 1, 1], physdims=[2, 2, 2])
        g.compute_geometry()
        sc_top = pp.fvutils.SubcellTopology(g)

        D_g, CC = pp.numerics.fv.mpsa.reconstruct_displacement(g, sc_top, eta=1)

        data = np.array(
            [
                -1.,
                -1.,
                -1.,
                1.,
                -1.,
                -1.,
                -1.,
                1.,
                -1.,
                1.,
                1.,
                -1.,
                -1.,
                -1.,
                1.,
                1.,
                -1.,
                1.,
                -1.,
                1.,
                1.,
                1.,
                1.,
                1.,
                -1.,
                -1.,
                -1.,
                1.,
                -1.,
                -1.,
                -1.,
                1.,
                -1.,
                1.,
                1.,
                -1.,
                -1.,
                -1.,
                1.,
                1.,
                -1.,
                1.,
                -1.,
                1.,
                1.,
                1.,
                1.,
                1.,
                -1.,
                -1.,
                -1.,
                1.,
                -1.,
                -1.,
                -1.,
                1.,
                -1.,
                1.,
                1.,
                -1.,
                -1.,
                -1.,
                1.,
                1.,
                -1.,
                1.,
                -1.,
                1.,
                1.,
                1.,
                1.,
                1.,
            ]
        )

        indices = np.array(
            [
                0,
                1,
                2,
                9,
                10,
                11,
                18,
                19,
                20,
                27,
                28,
                29,
                36,
                37,
                38,
                45,
                46,
                47,
                54,
                55,
                56,
                63,
                64,
                65,
                3,
                4,
                5,
                12,
                13,
                14,
                21,
                22,
                23,
                30,
                31,
                32,
                39,
                40,
                41,
                48,
                49,
                50,
                57,
                58,
                59,
                66,
                67,
                68,
                6,
                7,
                8,
                15,
                16,
                17,
                24,
                25,
                26,
                33,
                34,
                35,
                42,
                43,
                44,
                51,
                52,
                53,
                60,
                61,
                62,
                69,
                70,
                71,
            ]
        )

        indptr = np.array(
            [
                0,
                1,
                2,
                3,
                4,
                5,
                6,
                7,
                8,
                9,
                10,
                11,
                12,
                13,
                14,
                15,
                16,
                17,
                18,
                19,
                20,
                21,
                22,
                23,
                24,
                25,
                26,
                27,
                28,
                29,
                30,
                31,
                32,
                33,
                34,
                35,
                36,
                37,
                38,
                39,
                40,
                41,
                42,
                43,
                44,
                45,
                46,
                47,
                48,
                49,
                50,
                51,
                52,
                53,
                54,
                55,
                56,
                57,
                58,
                59,
                60,
                61,
                62,
                63,
                64,
                65,
                66,
                67,
                68,
                69,
                70,
                71,
                72,
            ]
        )

        CC_known = np.array(
            [
                [1., 0., 0.],
                [1., 0., 0.],
                [1., 0., 0.],
                [1., 0., 0.],
                [1., 0., 0.],
                [1., 0., 0.],
                [1., 0., 0.],
                [1., 0., 0.],
                [1., 0., 0.],
                [1., 0., 0.],
                [1., 0., 0.],
                [1., 0., 0.],
                [1., 0., 0.],
                [1., 0., 0.],
                [1., 0., 0.],
                [1., 0., 0.],
                [1., 0., 0.],
                [1., 0., 0.],
                [1., 0., 0.],
                [1., 0., 0.],
                [1., 0., 0.],
                [1., 0., 0.],
                [1., 0., 0.],
                [1., 0., 0.],
                [0., 1., 0.],
                [0., 1., 0.],
                [0., 1., 0.],
                [0., 1., 0.],
                [0., 1., 0.],
                [0., 1., 0.],
                [0., 1., 0.],
                [0., 1., 0.],
                [0., 1., 0.],
                [0., 1., 0.],
                [0., 1., 0.],
                [0., 1., 0.],
                [0., 1., 0.],
                [0., 1., 0.],
                [0., 1., 0.],
                [0., 1., 0.],
                [0., 1., 0.],
                [0., 1., 0.],
                [0., 1., 0.],
                [0., 1., 0.],
                [0., 1., 0.],
                [0., 1., 0.],
                [0., 1., 0.],
                [0., 1., 0.],
                [0., 0., 1.],
                [0., 0., 1.],
                [0., 0., 1.],
                [0., 0., 1.],
                [0., 0., 1.],
                [0., 0., 1.],
                [0., 0., 1.],
                [0., 0., 1.],
                [0., 0., 1.],
                [0., 0., 1.],
                [0., 0., 1.],
                [0., 0., 1.],
                [0., 0., 1.],
                [0., 0., 1.],
                [0., 0., 1.],
                [0., 0., 1.],
                [0., 0., 1.],
                [0., 0., 1.],
                [0., 0., 1.],
                [0., 0., 1.],
                [0., 0., 1.],
                [0., 0., 1.],
                [0., 0., 1.],
                [0., 0., 1.],
            ]
        )

        D_g_known = sps.csr_matrix((data, indices, indptr))
        self.assertTrue(np.all(np.abs(D_g - D_g_known).A < 1e-12))
        self.assertTrue(np.all(np.abs(CC - CC_known) < 1e-12))


def make_true_2d(g):
    if g.dim == 2:
        g = g.copy()
        g.cell_centers = np.delete(g.cell_centers, (2), axis=0)
        g.face_centers = np.delete(g.face_centers, (2), axis=0)
        g.face_normals = np.delete(g.face_normals, (2), axis=0)
        g.nodes = np.delete(g.nodes, (2), axis=0)

    return g
